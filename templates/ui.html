<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>__TITLE__</title>

  <!-- Fomantic UI -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.9.3/dist/semantic.min.css">

  <style>
    body {
      background-color: #1b1c1d;
    }

    /* Hlavní wrapper – full-width + padding */
    .page-container {
      margin: 0;
      padding: 1.5rem 2.5rem 3rem 2.5rem;
    }

    /* Header jako u actuator-proxy */
    .top-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .top-header-left .ui.header {
      margin: 0;
    }

    .top-header-left .ui.header .sub.header {
      font-size: 0.95rem;
      opacity: 0.8;
    }

    .top-header-right {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .top-header-right .download-label {
      font-size: 0.85rem;
      opacity: 0.9;
      color: rgba(255, 255, 255, 0.9);
    }

    .download-group {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .download-group .ui.button {
      margin-left: 0;
    }

    .download-group .copy-url-btn {
      padding: 0.25rem 0.4rem !important;
    }

    .controls-segment {
      margin-bottom: 1.5rem;
    }

    /* labely ve formu – aby nebyly černé */
    .controls-segment .ui.form .field > label {
      color: rgba(255, 255, 255, 0.9) !important;
    }

    .top-hint {
      margin-top: 0.5rem;
      font-size: 0.8rem;
      opacity: 0.8;
    }

    /* Terminálová okna pro logy – vertikálně pod sebou */
    .logs-grid {
      margin-top: 1.25rem;
    }

    .logs-grid .column {
      margin-bottom: 1.75rem;
    }

    .terminal-window {
      background: #111 !important;
      border-radius: 0.9rem !important;
      box-shadow: 0 26px 60px rgba(0, 0, 0, 0.9);
      padding: 0 !important;
      border: 1px solid rgba(255, 255, 255, 0.06);
    }

    .terminal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.55rem 0.9rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      background: linear-gradient(
        135deg,
        rgba(255, 255, 255, 0.08),
        rgba(255, 255, 255, 0.02)
      );
    }

    .terminal-left {
      display: flex;
      align-items: center;
    }

    .terminal-dots {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      margin-right: 0.8rem;
    }

    .terminal-dot {
      width: 0.7rem;
      height: 0.7rem;
      border-radius: 999px;
      background-color: #ff5f56;
    }

    .terminal-dot:nth-child(2) {
      background-color: #ffbd2e;
    }

    .terminal-dot:nth-child(3) {
      background-color: #27c93f;
    }

    .terminal-title {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .terminal-subtitle {
      font-size: 0.8rem;
      opacity: 0.8;
    }

    .terminal-actions .copy-log-btn {
      padding: 0.25rem 0.4rem !important;
    }

    .terminal-body {
      padding: 0.6rem 0.8rem 0.75rem 0.8rem;
    }

    .log-output {
      background: transparent !important;
      color: #f9fafb !important;
      height: 32vh;      /* fixní výška – oba logy stejné */
      max-height: none;
      overflow-y: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 0.8rem;
      white-space: pre;
      margin: 0;
    }

    .log-output::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .log-output::-webkit-scrollbar-thumb {
      background-color: #444;
      border-radius: 4px;
    }
  </style>
</head>
<body class="ui inverted">

  <div class="page-container">
    <!-- Header -->
    <div class="top-header">
      <div class="top-header-left">
        <h1 class="ui inverted header">
          <i class="file alternate outline icon"></i>
          <div class="content">
            <span id="page-title">__TITLE__</span>
            <div class="sub header">
              Nginx access/error log viewer
            </div>
          </div>
        </h1>
      </div>
      <div class="top-header-right">
        <div id="sse-status" class="ui green tiny label">
          <i class="circle icon"></i>
          LIVE
        </div>

        <span class="download-label">Download:</span>

        <div class="download-group">
          <a id="download-access" href="access.log.gz" class="ui mini inverted basic button">
            access.log (gz)
          </a>
          <button
            type="button"
            class="ui mini inverted icon button copy-url-btn"
            data-href="access.log.gz"
            title="Copy URL to clipboard">
            <i class="copy icon"></i>
          </button>
        </div>

        <div class="download-group">
          <a id="download-error" href="error.log.gz" class="ui mini inverted basic button">
            error.log (gz)
          </a>
          <button
            type="button"
            class="ui mini inverted icon button copy-url-btn"
            data-href="error.log.gz"
            title="Copy URL to clipboard">
            <i class="copy icon"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Controls -->
    <div class="ui inverted segment controls-segment">
      <form id="controls-form" class="ui form">
        <div class="fields">
          <div class="field">
            <label>Lines per log</label>
            <select name="limit" id="limit" class="ui dropdown">
              __LIMIT_OPTIONS__
            </select>
          </div>
          <div class="field">
            <label>Refresh</label>
            <select name="refresh" id="refresh" class="ui dropdown">
              __REFRESH_OPTIONS__
            </select>
          </div>
          <div class="field">
            <label>Filter</label>
            <div class="ui icon input">
              <input id="log-filter" type="text" placeholder="substring, e.g. 10.220.18.2">
              <i class="search icon"></i>
            </div>
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <button type="submit" class="ui primary button">
              <i class="play icon"></i>
              Apply
            </button>
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <button type="button" id="pause-btn" class="ui basic red button">
              <i class="pause icon"></i>
              Pause
            </button>
          </div>
        </div>
      </form>
      <div class="top-hint">
        Newest entries are shown at the top. Logs are updated live; controls change how many
        lines are kept in view and how often the server pushes updates (choose 0s for realtime).
        Filter is applied client-side on the latest N lines.
      </div>
    </div>

    <!-- Logs – dva terminály pod sebou -->
    <div class="ui grid logs-grid">
      <div class="sixteen wide column">
        <div class="ui inverted segment terminal-window">
          <div class="terminal-header">
            <div class="terminal-left">
              <div class="terminal-dots">
                <span class="terminal-dot"></span>
                <span class="terminal-dot"></span>
                <span class="terminal-dot"></span>
              </div>
              <div>
                <div class="terminal-title">access.log</div>
                <div class="terminal-subtitle">
                  latest <span id="access-limit-label">__LIMIT__</span> lines
                </div>
              </div>
            </div>
            <div class="terminal-actions">
              <button
                type="button"
                class="ui mini inverted icon button copy-log-btn"
                data-target="access-log"
                title="Copy visible access.log to clipboard">
                <i class="copy icon"></i>
              </button>
            </div>
          </div>
          <div class="terminal-body">
            <pre id="access-log" class="log-output">__ACCESS__</pre>
          </div>
        </div>
      </div>

      <div class="sixteen wide column">
        <div class="ui inverted segment terminal-window">
          <div class="terminal-header">
            <div class="terminal-left">
              <div class="terminal-dots">
                <span class="terminal-dot"></span>
                <span class="terminal-dot"></span>
                <span class="terminal-dot"></span>
              </div>
              <div>
                <div class="terminal-title">error.log</div>
                <div class="terminal-subtitle">
                  latest <span id="error-limit-label">__LIMIT__</span> lines
                </div>
              </div>
            </div>
            <div class="terminal-actions">
              <button
                type="button"
                class="ui mini inverted icon button copy-log-btn"
                data-target="error-log"
                title="Copy visible error.log to clipboard">
                <i class="copy icon"></i>
              </button>
            </div>
          </div>
          <div class="terminal-body">
            <pre id="error-log" class="log-output">__ERROR__</pre>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fomantic-ui@2.9.3/dist/semantic.min.js"></script>
  <script>
    (function () {
      'use strict';

      const limitSelect = document.getElementById('limit');
      const refreshSelect = document.getElementById('refresh');
      const filterInput = document.getElementById('log-filter');
      const form = document.getElementById('controls-form');
      const accessPre = document.getElementById('access-log');
      const errorPre = document.getElementById('error-log');
      const pauseBtn = document.getElementById('pause-btn');
      const accessLimitLabel = document.getElementById('access-limit-label');
      const errorLimitLabel = document.getElementById('error-limit-label');
      const sseStatus = document.getElementById('sse-status');

      // Fomantic dropdowns
      if (window.jQuery) {
        $('.ui.dropdown').dropdown();
      }

      let es = null;
      let isPaused = false;

      // aktuální poslední N řádků (nejnovější první)
      let latestAccessLines = [];
      let latestErrorLines = [];
      let logFilter = '';

      function copyTextToClipboard(text) {
        if (!text) text = '';
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text).catch(function (err) {
            console.error('Clipboard write failed', err);
          });
        } else {
          const textarea = document.createElement('textarea');
          textarea.value = text;
          textarea.style.position = 'fixed';
          textarea.style.left = '-9999px';
          document.body.appendChild(textarea);
          textarea.focus();
          textarea.select();
          try {
            document.execCommand('copy');
          } catch (err) {
            console.error('execCommand copy failed', err);
          }
          document.body.removeChild(textarea);
        }
      }

      // Copy visible log contents
      document.querySelectorAll('.copy-log-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
          const targetId = btn.dataset.target;
          const pre = document.getElementById(targetId);
          if (pre) {
            copyTextToClipboard(pre.textContent || '');
          }
        });
      });

      // Copy download URLs
      document.querySelectorAll('.copy-url-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
          const href = btn.dataset.href;
          if (!href) return;
          const url = new URL(href, window.location.href).toString();
          copyTextToClipboard(url);
        });
      });

      function setStatus(online) {
        if (!sseStatus) return;
        sseStatus.classList.remove('green', 'red');
        sseStatus.classList.add(online ? 'green' : 'red');
        sseStatus.innerHTML =
          '<i class="circle icon"></i> ' + (online ? 'LIVE' : 'OFFLINE');
      }

      function updatePauseButton() {
        if (!pauseBtn) return;
        if (isPaused) {
          pauseBtn.className = 'ui basic grey button';
          pauseBtn.innerHTML = '<i class="play icon"></i>Continue';
        } else {
          pauseBtn.className = 'ui basic red button';
          pauseBtn.innerHTML = '<i class="pause icon"></i>Pause';
        }
      }

      function updateLimitLabels() {
        const limit = limitSelect.value;
        if (accessLimitLabel) accessLimitLabel.textContent = limit;
        if (errorLimitLabel) errorLimitLabel.textContent = limit;
      }

      function renderLogs() {
        const filter = (logFilter || '').toLowerCase();
        const accessLines = !filter
          ? latestAccessLines
          : latestAccessLines.filter(l => l.toLowerCase().includes(filter));
        const errorLines = !filter
          ? latestErrorLines
          : latestErrorLines.filter(l => l.toLowerCase().includes(filter));

        accessPre.textContent = accessLines.join('\n');
        errorPre.textContent = errorLines.join('\n');
      }

      function startStream() {
        if (isPaused) {
          return;
        }

        if (es) {
          es.close();
          es = null;
        }

        const limit = limitSelect.value;
        const interval = refreshSelect.value;

        updateLimitLabels();

        const params = new URLSearchParams({ limit, interval });
        const sseUrl = 'logs/stream?' + params.toString();

        try {
          es = new EventSource(sseUrl);
        } catch (e) {
          console.error('Failed to create EventSource', e);
          setStatus(false);
          return;
        }

        es.onmessage = function (event) {
          setStatus(true);
          try {
            const data = JSON.parse(event.data);

            if (Array.isArray(data.access)) {
              // nejnovější nahoře
              latestAccessLines = data.access.slice().reverse();
            }
            if (Array.isArray(data.error)) {
              latestErrorLines = data.error.slice().reverse();
            }

            renderLogs();
          } catch (e) {
            console.error('Failed to parse SSE payload', e);
          }
        };

        es.onerror = function (err) {
          console.error('SSE error', err);
          setStatus(false);
        };
      }

      // aktualizace labelu okamžitě při změně selectu
      limitSelect.addEventListener('change', updateLimitLabels);

      // filtr – klientská substring match (case-insensitive)
      if (filterInput) {
        filterInput.addEventListener('input', function () {
          logFilter = filterInput.value || '';
          renderLogs();
        });
      }

      form.addEventListener('submit', function (e) {
        e.preventDefault();
        const url = new URL(window.location.href);
        url.searchParams.set('limit', limitSelect.value);
        url.searchParams.set('refresh', refreshSelect.value);
        window.history.replaceState(null, '', url.toString());
        if (!isPaused) {
          startStream();
        }
      });

      pauseBtn.addEventListener('click', function () {
        if (!isPaused) {
          // Pause
          isPaused = true;
          updatePauseButton();
          if (es) {
            es.close();
            es = null;
          }
        } else {
          // Continue
          isPaused = false;
          updatePauseButton();
          startStream();
        }
      });

      // Initialize in-memory arrays from what server rendered in <pre> tags
      if (accessPre && accessPre.textContent) {
        latestAccessLines = accessPre.textContent.split('\n');
      }
      if (errorPre && errorPre.textContent) {
        latestErrorLines = errorPre.textContent.split('\n');
      }

      updateLimitLabels();
      updatePauseButton();
      renderLogs();
      startStream();
    })();
  </script>
</body>
</html>
